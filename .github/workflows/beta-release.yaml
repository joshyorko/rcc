name: Beta Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Beta tag name (e.g., v19.0.0-beta.1+zstd)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  build:
    name: Build Beta RCC
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - uses: actions/setup-go@v6
        with:
          go-version: "1.20.x"
          
      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          
      - name: Install invoke
        run: python -m pip install invoke

      - name: Verify version matches tag
        run: |
          VERSION=$(grep 'Version = ' common/version.go | cut -d'`' -f2)
          echo "Code version: $VERSION"
          echo "Tag: ${{ inputs.tag }}"
          if [[ "$VERSION" != "${{ inputs.tag }}" ]]; then
            echo "::warning::Version in code ($VERSION) doesn't match tag (${{ inputs.tag }})"
          fi

      - name: Build RCC
        run: inv build

      - name: Prepare artifacts
        run: |
          mkdir -p rcc-beta
          cp build/linux64/rcc rcc-beta/rcc-linux64
          cp build/linux64/rccremote rcc-beta/rccremote-linux64
          cp build/windows64/rcc.exe rcc-beta/rcc-windows64.exe
          cp build/windows64/rccremote.exe rcc-beta/rccremote-windows64.exe
          cp build/darwin64/rcc rcc-beta/rcc-darwin64
          cp build/darwin64/rccremote rcc-beta/rcc-darwin64

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rcc-beta-binaries
          path: rcc-beta/

  test-linux:
    name: Test Linux
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - uses: actions/setup-go@v6
        with:
          go-version: "1.20.x"
          
      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install invoke
        run: python -m pip install invoke

      - name: Setup Robot
        run: inv robotsetup

      - name: Run Robot Tests
        run: inv robot

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: linux-test-results
          path: tmp/output/

  test-windows:
    name: Test Windows
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v5
      
      - uses: actions/setup-go@v6
        with:
          go-version: "1.20.x"
          
      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install invoke
        run: python -m pip install invoke

      - name: Setup Robot
        run: inv robotsetup

      - name: Run Robot Tests
        run: inv robot

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-test-results
          path: tmp/output/

  release-beta:
    name: Create Beta Release
    needs: [build, test-linux, test-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: rcc-beta-binaries
          path: rcc-beta/

      - name: Generate beta index.json
        env:
          VERSION: ${{ inputs.tag }}
          REPO: ${{ github.repository }}
        run: |
          DATE=$(date +"%d.%-m.%Y")
          
          cat > rcc-beta/index.json << EOF
          {
            "beta": [
              {
                "version": "$VERSION",
                "when": "$DATE",
                "changelog": "https://github.com/$REPO/blob/${{ github.sha }}/docs/changelog.md",
                "windows": "https://github.com/$REPO/releases/download/$VERSION/rcc-windows64.exe",
                "linux": "https://github.com/$REPO/releases/download/$VERSION/rcc-linux64",
                "macos": "https://github.com/$REPO/releases/download/$VERSION/rcc-darwin64",
                "notes": "Beta release with zstd compression support"
              }
            ]
          }
          EOF
          
          cat rcc-beta/index.json

      - name: Create beta release
        uses: softprops/action-gh-release@v2
        with:
          files: rcc-beta/*
          tag_name: ${{ inputs.tag }}
          target_commitish: ${{ github.sha }}
          name: "RCC ${{ inputs.tag }} (Beta)"
          draft: false
          prerelease: ${{ inputs.prerelease }}
          body: |
            ## Beta Release: ${{ inputs.tag }}
            
            ⚠️ **This is a pre-release version for testing purposes.**
            
            ### What's New
            - **zstd compression** for holotree/hololib (replaces gzip)
            - ~3x faster environment restore times
            - Backward compatible: can read old gzip files
            
            ### Testing Notes
            - Test with your existing holotree environments
            - Report any issues to the [zstd PR](https://github.com/${{ github.repository }}/pull/64)
            
            ### Installation
            Download the binary for your platform and replace your existing RCC.
            
            ### Commit
            Built from: ${{ github.sha }}
