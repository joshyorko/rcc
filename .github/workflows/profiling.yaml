name: Compression Profiling

on:
  workflow_dispatch:
    inputs:
      run_heavy:
        description: 'Run heavy environment tests (slower)'
        required: false
        default: true
        type: boolean
  pull_request:
    branches:
      - main
    paths:
      - 'htfs/**'
      - 'conda/**'
      - 'common/version.go'

permissions:
  contents: read

jobs:
  profile:
    name: Profile ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
          - os: windows
            runner: windows-latest

    steps:
      - uses: actions/checkout@v5
      
      - uses: actions/setup-go@v6
        with:
          go-version: "1.20.x"
          
      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install invoke
        run: python -m pip install invoke

      - name: Setup Robot Environment
        run: inv robotsetup

      - name: Create output directories
        shell: bash
        run: mkdir -p tmp/profiles tmp/output

      # ============================================
      # DOWNLOAD RELEASE RCC (GZIP BASELINE)
      # ============================================
      - name: Download release RCC (gzip baseline)
        shell: bash
        run: |
          mkdir -p tmp/baseline
          echo "## ðŸ“Š Compression Comparison: v18.12.1 (gzip) vs PR (zstd)" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            curl -sL "https://github.com/joshyorko/rcc/releases/download/v18.12.1/rcc-windows64.exe" -o tmp/baseline/rcc.exe
            chmod +x tmp/baseline/rcc.exe
            echo "BASELINE_RCC=tmp/baseline/rcc.exe" >> $GITHUB_ENV
          else
            curl -sL "https://github.com/joshyorko/rcc/releases/download/v18.12.1/rcc-linux64" -o tmp/baseline/rcc
            chmod +x tmp/baseline/rcc
            echo "BASELINE_RCC=tmp/baseline/rcc" >> $GITHUB_ENV
          fi

      - name: Show baseline RCC version
        shell: bash
        run: |
          echo "### Baseline (gzip)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          $BASELINE_RCC version >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Prepare assets
        run: inv assets

      - name: Build PR branch RCC
        run: inv local

      - name: Show PR RCC version
        shell: bash
        run: |
          echo "### PR Branch (zstd)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./build/rcc version >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ============================================
      # BASELINE (GZIP) PROFILING
      # ============================================
      - name: Clean holotree for baseline
        shell: bash
        run: |
          $BASELINE_RCC ht delete baseline-small --controller profiling 2>/dev/null || true
          $BASELINE_RCC ht delete baseline-medium --controller profiling 2>/dev/null || true
          $BASELINE_RCC config cleanup --controller profiling 2>/dev/null || true

      - name: Baseline - Small env fresh build
        shell: bash
        run: |
          START=$(date +%s)
          $BASELINE_RCC ht vars --space baseline-small --controller profiling robot_tests/conda.yaml 2>&1 | tee tmp/profiles/baseline-small-fresh.log
          END=$(date +%s)
          echo "BASELINE_SMALL_FRESH=$((END - START))" >> $GITHUB_ENV

      - name: Baseline - Small env restore
        shell: bash
        run: |
          $BASELINE_RCC ht delete baseline-small --controller profiling
          START=$(date +%s)
          $BASELINE_RCC ht vars --space baseline-small --controller profiling robot_tests/conda.yaml 2>&1 | tee tmp/profiles/baseline-small-restore.log
          END=$(date +%s)
          echo "BASELINE_SMALL_RESTORE=$((END - START))" >> $GITHUB_ENV

      - name: Baseline - Medium env fresh build
        shell: bash
        run: |
          START=$(date +%s)
          $BASELINE_RCC ht vars --space baseline-medium --controller profiling robot_tests/profile_conda_medium.yaml 2>&1 | tee tmp/profiles/baseline-medium-fresh.log || true
          END=$(date +%s)
          echo "BASELINE_MEDIUM_FRESH=$((END - START))" >> $GITHUB_ENV

      - name: Baseline - Medium env restore
        shell: bash
        run: |
          $BASELINE_RCC ht delete baseline-medium --controller profiling 2>/dev/null || true
          START=$(date +%s)
          $BASELINE_RCC ht vars --space baseline-medium --controller profiling robot_tests/profile_conda_medium.yaml 2>&1 | tee tmp/profiles/baseline-medium-restore.log || true
          END=$(date +%s)
          echo "BASELINE_MEDIUM_RESTORE=$((END - START))" >> $GITHUB_ENV

      - name: Cleanup baseline holotree
        shell: bash
        run: |
          $BASELINE_RCC ht delete baseline-small --controller profiling 2>/dev/null || true
          $BASELINE_RCC ht delete baseline-medium --controller profiling 2>/dev/null || true
          $BASELINE_RCC config cleanup --controller profiling 2>/dev/null || true

      # ============================================
      # PR (ZSTD) PROFILING
      # ============================================
      - name: Clean holotree for PR
        shell: bash
        run: |
          ./build/rcc ht delete pr-small --controller profiling 2>/dev/null || true
          ./build/rcc ht delete pr-medium --controller profiling 2>/dev/null || true
          ./build/rcc config cleanup --controller profiling 2>/dev/null || true

      - name: PR - Small env fresh build
        shell: bash
        run: |
          START=$(date +%s)
          ./build/rcc ht vars --space pr-small --controller profiling robot_tests/conda.yaml 2>&1 | tee tmp/profiles/pr-small-fresh.log
          END=$(date +%s)
          echo "PR_SMALL_FRESH=$((END - START))" >> $GITHUB_ENV

      - name: PR - Small env restore
        shell: bash
        run: |
          ./build/rcc ht delete pr-small --controller profiling
          START=$(date +%s)
          ./build/rcc ht vars --space pr-small --controller profiling robot_tests/conda.yaml 2>&1 | tee tmp/profiles/pr-small-restore.log
          END=$(date +%s)
          echo "PR_SMALL_RESTORE=$((END - START))" >> $GITHUB_ENV

      - name: PR - Medium env fresh build
        shell: bash
        run: |
          START=$(date +%s)
          ./build/rcc ht vars --space pr-medium --controller profiling robot_tests/profile_conda_medium.yaml 2>&1 | tee tmp/profiles/pr-medium-fresh.log
          END=$(date +%s)
          echo "PR_MEDIUM_FRESH=$((END - START))" >> $GITHUB_ENV

      - name: PR - Medium env restore
        shell: bash
        run: |
          ./build/rcc ht delete pr-medium --controller profiling
          START=$(date +%s)
          ./build/rcc ht vars --space pr-medium --controller profiling robot_tests/profile_conda_medium.yaml 2>&1 | tee tmp/profiles/pr-medium-restore.log
          END=$(date +%s)
          echo "PR_MEDIUM_RESTORE=$((END - START))" >> $GITHUB_ENV

      # ============================================
      # COMPARISON SUMMARY TABLE
      # ============================================
      - name: Generate comparison table
        shell: bash
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš¡ Performance Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Operation | v18.12.1 (gzip) | PR (zstd) | Î” |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----------|-----------------|-----------|---|" >> $GITHUB_STEP_SUMMARY
          
          # Small fresh
          DIFF=$((BASELINE_SMALL_FRESH - PR_SMALL_FRESH))
          if [ $DIFF -gt 0 ]; then ICON="ðŸŸ¢ -${DIFF}s"; elif [ $DIFF -eq 0 ]; then ICON="âšª 0s"; else ICON="ðŸ”´ +$((-DIFF))s"; fi
          echo "| Small | Fresh build | ${BASELINE_SMALL_FRESH}s | ${PR_SMALL_FRESH}s | $ICON |" >> $GITHUB_STEP_SUMMARY
          
          # Small restore
          DIFF=$((BASELINE_SMALL_RESTORE - PR_SMALL_RESTORE))
          if [ $DIFF -gt 0 ]; then ICON="ðŸŸ¢ -${DIFF}s"; elif [ $DIFF -eq 0 ]; then ICON="âšª 0s"; else ICON="ðŸ”´ +$((-DIFF))s"; fi
          echo "| Small | **Restore** | ${BASELINE_SMALL_RESTORE}s | ${PR_SMALL_RESTORE}s | $ICON |" >> $GITHUB_STEP_SUMMARY
          
          # Medium fresh
          DIFF=$((BASELINE_MEDIUM_FRESH - PR_MEDIUM_FRESH))
          if [ $DIFF -gt 0 ]; then ICON="ðŸŸ¢ -${DIFF}s"; elif [ $DIFF -eq 0 ]; then ICON="âšª 0s"; else ICON="ðŸ”´ +$((-DIFF))s"; fi
          echo "| Medium | Fresh build | ${BASELINE_MEDIUM_FRESH}s | ${PR_MEDIUM_FRESH}s | $ICON |" >> $GITHUB_STEP_SUMMARY
          
          # Medium restore  
          DIFF=$((BASELINE_MEDIUM_RESTORE - PR_MEDIUM_RESTORE))
          if [ $DIFF -gt 0 ]; then ICON="ðŸŸ¢ -${DIFF}s"; elif [ $DIFF -eq 0 ]; then ICON="âšª 0s"; else ICON="ðŸ”´ +$((-DIFF))s"; fi
          echo "| Medium | **Restore** | ${BASELINE_MEDIUM_RESTORE}s | ${PR_MEDIUM_RESTORE}s | $ICON |" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # HEAVY ENVIRONMENT PROFILING (optional)
      # ============================================
      - name: Profile heavy env - Fresh build
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_heavy != false }}
        shell: bash
        run: |
          echo "## Heavy Environment (data science stack)" >> $GITHUB_STEP_SUMMARY
          echo "### Fresh Build" >> $GITHUB_STEP_SUMMARY
          
          START=$(date +%s)
          ./build/rcc ht vars --space profile-heavy \
            --controller profiling \
            robot_tests/profile_conda_heavy.yaml 2>&1 | tee tmp/profiles/heavy-fresh.log
          END=$(date +%s)
          
          echo "- **Fresh build time**: $((END - START))s" >> $GITHUB_STEP_SUMMARY

      - name: Profile heavy env - Restore
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_heavy != false }}
        shell: bash
        run: |
          echo "### Restore from Hololib" >> $GITHUB_STEP_SUMMARY
          
          ./build/rcc ht delete profile-heavy --controller profiling
          
          START=$(date +%s)
          ./build/rcc ht vars --space profile-heavy \
            --controller profiling \
            robot_tests/profile_conda_heavy.yaml 2>&1 | tee tmp/profiles/heavy-restore.log
          END=$(date +%s)
          
          echo "- **Restore time**: $((END - START))s" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # VERIFY ZSTD COMPRESSION
      # ============================================
      - name: Verify zstd compression
        shell: bash
        run: |
          echo "## Compression Verification" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            HOLOLIB_PATH="$LOCALAPPDATA/robocorp/hololib"
          else
            HOLOLIB_PATH="$HOME/.robocorp/hololib"
          fi
          
          echo "Checking files in: $HOLOLIB_PATH"
          
          if [ -d "$HOLOLIB_PATH" ]; then
            ZSTD_COUNT=0
            GZIP_COUNT=0
            OTHER_COUNT=0
            TOTAL=0
            
            for f in $(find "$HOLOLIB_PATH" -type f 2>/dev/null | head -100); do
              TOTAL=$((TOTAL + 1))
              MAGIC=$(xxd -l 4 -p "$f" 2>/dev/null || echo "error")
              if [[ "$MAGIC" == "28b52ffd" ]]; then
                ZSTD_COUNT=$((ZSTD_COUNT + 1))
              elif [[ "$MAGIC" == "1f8b"* ]]; then
                GZIP_COUNT=$((GZIP_COUNT + 1))
              else
                OTHER_COUNT=$((OTHER_COUNT + 1))
              fi
            done
            
            echo "| Format | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| zstd | $ZSTD_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| gzip (legacy) | $GZIP_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| other/catalog | $OTHER_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total sampled** | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            
            if [[ $ZSTD_COUNT -gt 0 && $GZIP_COUNT -eq 0 ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **All compressed files are using zstd!**" >> $GITHUB_STEP_SUMMARY
            elif [[ $GZIP_COUNT -gt 0 ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Found legacy gzip files** - this may be expected if reading old cache" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Hololib directory not found at $HOLOLIB_PATH" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Holotree statistics
        shell: bash
        run: |
          echo "## Holotree Statistics" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./build/rcc ht stats --controller profiling >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload profiling artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: profiling-${{ matrix.os }}
          path: tmp/profiles/
          retention-days: 30

      - name: Cleanup
        if: always()
        shell: bash
        run: |
          $BASELINE_RCC ht delete baseline-small --controller profiling 2>/dev/null || true
          $BASELINE_RCC ht delete baseline-medium --controller profiling 2>/dev/null || true
          ./build/rcc ht delete pr-small --controller profiling 2>/dev/null || true
          ./build/rcc ht delete pr-medium --controller profiling 2>/dev/null || true
          ./build/rcc ht delete profile-heavy --controller profiling 2>/dev/null || true
          ./build/rcc config cleanup --controller profiling 2>/dev/null || true
