name: Rcc
on:
  workflow_dispatch: # Enables manual triggering
    inputs:
      tag:
        description: "Tag name to release (e.g., v18.5.0)"
        required: false
        type: string
  push:
    branches:
      - main

    tags:
      - "v*" # Run when a new version tag (e.g., v18.5.0) is pushed
    paths-ignore:
      - ".github/workflows/**"
      - ".dagger/**"

  pull_request:
    branches:
      - main
    paths-ignore:
      - ".github/workflows/**"
      - ".dagger/**"

permissions:
  contents: read

jobs:
  build:
    name: Build RCC
    runs-on: ubuntu-latest
    # Build only as part of a release flow (tag push or manual dispatch).
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    steps:
      # Checkout first so setup-go can locate go.mod/go.sum for caching
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: "1.23.12"
      - name: Set up Python 3.10
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      - name: Install invoke
        run: python -m pip install invoke
      - name: Show commit info
        run: inv what
      - name: Debug Build Job
        run: |
          echo "GitHub ref: ${{ github.ref }}"
          echo "GitHub event name: ${{ github.event_name }}"
          echo "Job status: ${{ job.status }}"
      - name: Build RCC
        run: inv build
      - name: Prepare Artifacts
        run: |
          mkdir -p rcc-builds
          cp build/linux64/rcc rcc-builds/rcc-linux64
          cp build/linux64/rccremote rcc-builds/rccremote-linux64
          cp build/windows64/rcc.exe rcc-builds/rcc-windows64.exe
          cp build/windows64/rccremote.exe rcc-builds/rccremote-windows64.exe
          cp build/macos64/rcc rcc-builds/rcc-macos64
          cp build/macos64/rccremote rcc-builds/rccremote-macos64
          cp build/macosarm64/rcc rcc-builds/rcc-macosarm64
          cp build/macosarm64/rccremote rcc-builds/rccremote-macosarm64
      - name: Upload RCC Binaries
        uses: actions/upload-artifact@v4.6.2
        with:
          name: RCC-Binaries
          path: rcc-builds/

  robot:
    name: Robot Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "windows-latest"]
    steps:
      # Checkout first so setup-go can locate go.mod/go.sum for caching
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: "1.23.12"
      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      - name: Install invoke
        run: python -m pip install invoke
      - name: Setup Robot Environment
        run: inv robotsetup
      - name: Show commit info
        run: inv what
      - name: Run Robot Framework Tests
        run: inv robot
      - uses: actions/upload-artifact@v4.6.2
        if: success() || failure()
        with:
          name: ${{ matrix.os }}-test-reports
          path: ./tmp/output/

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    needs:
      - build
      - robot
    # Only run this job on tag pushes (e.g., refs/tags/v18.5.0) or manual dispatch
    # Grant only the permissions needed to publish a release
    permissions:
      contents: write

    steps:
      - name: Debug Release Job
        run: |
          echo "GitHub ref: ${{ github.ref }}"
          echo "GitHub event name: ${{ github.event_name }}"
          echo "Build job status: ${{ needs.build.result }}"
          echo "Robot job status: ${{ needs.robot.result }}"
      - uses: actions/checkout@v5
      - name: Download Built RCC Binaries
        uses: actions/download-artifact@v5
        with:
          name: RCC-Binaries
          path: rcc-builds/
      - name: Set up Python 3.10
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      - name: Generate index.json
        env:
          VERSION: ${{ inputs.tag || github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          export DATE=$(date +"%d.%-m.%Y")

          # Try to fetch existing index.json from latest release
          curl -sL "https://github.com/${REPO}/releases/latest/download/index.json" -o existing.json 2>/dev/null || echo '{"tested":[],"edge":[]}' > existing.json

          # Generate new index.json with this version prepended
          python3 << 'PYEOF'
          import json
          import os

          version = os.environ["VERSION"]
          date = os.environ.get("DATE", "")
          repo = os.environ["REPO"]

          # Load existing or create new
          try:
              with open('existing.json') as f:
                  data = json.load(f)
          except:
              data = {"tested": [], "edge": []}

          # Build download URLs for GitHub releases
          base_url = f"https://github.com/{repo}/releases/download/{version}"
          # Generate changelog anchor (v18.12.0 -> v18120)
          changelog_anchor = version.replace(".", "")

          new_entry = {
              "version": version,
              "when": date,
              "changelog": f"https://github.com/{repo}/blob/main/docs/changelog.md#{changelog_anchor}",
              "windows": f"{base_url}/rcc-windows64.exe",
              "linux": f"{base_url}/rcc-linux64",
              "macos": f"{base_url}/rcc-darwin64"
          }

          # Remove duplicate if exists
          data["tested"] = [v for v in data.get("tested", []) if v["version"] != version]

          # Prepend new version
          data["tested"] = [new_entry] + data["tested"]

          # Keep last 20 versions
          data["tested"] = data["tested"][:20]

          with open('rcc-builds/index.json', 'w') as f:
              json.dump(data, f, indent=1)

          print(f"Generated index.json with {len(data['tested'])} versions")
          PYEOF

          cat rcc-builds/index.json
      - name: Delete existing release and tag if present
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          # Delete release if exists
          if gh release view "$TAG" &>/dev/null; then
            echo "Deleting existing release for $TAG..."
            gh release delete "$TAG" --yes --cleanup-tag
          else
            echo "No existing release for $TAG"
          fi
          # Also delete tag if it exists (GitHub taints tags used by published releases)
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "Deleting existing tag $TAG..."
            git push origin --delete "$TAG" || true
          fi
      - name: Publish Release
        uses: softprops/action-gh-release@v2.3.2
        with:
          files: rcc-builds/*
          tag_name: ${{ inputs.tag || github.ref_name }}
          target_commitish: ${{ github.sha }}
          draft: false
          prerelease: false
